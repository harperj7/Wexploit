<?php namespace App\Http\Controllers;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\ExploitType;
use App\Notice;
use Mail;

use Illuminate\Http\Request;

class NoticesController extends Controller {

	public function __construct() {

		$this->middleware('auth');
	}

	public function index() {

		$notices = \Auth::user()->notices()->latest()->get();

		return view('notices.index', compact('notices'));
		// return \Auth::user()->notices;
	}

	public function create() {

		$exploit_types = ExploitType::lists('name', 'id');

		return view('notices.create', compact('exploit_types'));

	}

	public function confirm(Requests\PrepareNoticeRequest $request) {

		$data = $request->all() + [
			'name' => \Auth::user()->name,
			'email' => \Auth::user()->email
		];

		$template = view()->file(app_path('Http/Templates/dmca.blade.php'), $data);

		session()->flash('dmca', $data);

		return view('notices.confirm', compact('template'));

	}

	public function store(Request $request) {

		$data = session()->get('dmca');

		//$notice = session()->get('dmca') + ['template' => $request->input('template')];
		$notice = Notice::open($data)->useTemplate($request->input('template'));

		$notice = \Auth::user()->notices()->save($notice);
		//$notice = \Auth::user()->notices()->create($notice);

		Mail::queue(['text' => 'emails.dmca'], compact('notice'), function($message) use ($notice) {

			$message->from($notice->getOwnerEmail())
					->to($notice->getRecipientEmail())
					->subject('DMCA Notice');

		});

		flash('DMCA notice successfully create.');
		
		return redirect('notices');

	}

	public function update($noticeId, Request $request) {
		
		$isRemoved = $request->has('content_removed');

		Notice::findOrFail($noticeId)->update(['content_removed' => $isRemoved]);
		
	}

}
